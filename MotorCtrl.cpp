/*
  -----------------------------------------------------------------------------
  DESCRIPTION: This file contains the functions necessary to interact with the motor.
        setup_pins()   Initialize the Timer Compare interrupts. We have two; one for the main control loop and another for constant acceleration control

        stop_motor()   Stop the motor

        sine_lookup()  Take a value and return its sine

        output()       Take a target angle and the effort to expend and move the motor

        one_step()     Move the stepper motor one step in the target direction

  SHARED VARIABLES: None

        Various built-in interrupt control registers are set; no new global variables are used in this file.

  INCLUDES:
        MotorCtrl.h: Contains macros and function declarations
        fastPWM.h:   Faster PWM than built-in function; architecture-specific
        TimeControlInt.h: We need this to turn off the interrupts
        MagneticEncoder.h: For macros and encoder reading functions
        SPI.h: Has macros and definitions for the board
  -----------------------------------------------------------------------------
*/

#include "MotorCtrl.h"
#include "fastPWM.h"
#include "TimeControlInt.h"
#include "MagneticEncoder.h"
#include <SPI.h>

// Define global constants
extern const int STEP_PER_REV = 200;
extern const int VALS_PER_REV = ((1<<14) + 16);
extern const int VAL_PER_STEP = (VALS_PER_REV/STEP_PER_REV);
extern const int QUARTER_TURN = (VALS_PER_REV/4);
extern const int MICROSTEPS   = 32;          // 1/32 microstepping
extern const int MOTOR_SETTLE = 10;        // ms it takes for the motor to settle
extern const bool CCW = true;
extern const bool CW = false;
// Create constant parameters for controlling the motor
const float iMAX   = 1.5;           // While the A4954 driver is rated for 2.0 Amp peak currents, it cannot handle these currents continuously.  Depending on how you operate the Mechaduino, you may be able to safely raise this value; refer to the A4954 datasheet for more info
const float rSense = 0.150;         // Sense resistor resistance in ohms
extern const int   uMAX = (255/3.3)*(iMAX*10*rSense); // Set the maximum "effort"; (225 duty/3.3 volts) * (iMax amps * rSense ohms * 10) gives us a way to convert from target current to PWM duty cycle

// Local constants
// Pin numbers
const int IN_4 = 6;
const int IN_3 = 5;
const int VREF_2 = 4;
const int VREF_1 = 9;
const int IN_2 = 7;
const int IN_1 = 8;
const int ledPin = 13;


// Sine lookup table; values range from 0 to 2^16; we have a total of QUARTER_TURN values. see the .h file for the macro definitions
const int SINETABLE[] = {0, 25, 50, 75, 100, 126, 151, 176, 201, 226, 251, 276, 301, 326, 352, 377, 402, 427, 452, 477, 502, 527, 552, 577, 603, 628, 653, 678, 703, 728, 753, 778, 803, 829, 854, 879, 904, 929, 954, 979, 1004, 1029, 1054, 1080, 1105, 1130, 1155, 1180, 1205, 1230, 1255, 1280, 1306, 1331, 1356, 1381, 1406, 1431, 1456, 1481, 1506, 1531, 1557, 1582, 1607, 1632, 1657, 1682, 1707, 1732, 1757, 1782, 1808, 1833, 1858, 1883, 1908, 1933, 1958, 1983, 2008, 2033, 2059, 2084, 2109, 2134, 2159, 2184, 2209, 2234, 2259, 2284, 2309, 2335, 2360, 2385, 2410, 2435, 2460, 2485, 2510, 2535, 2560, 2585, 2611, 2636, 2661, 2686, 2711, 2736, 2761, 2786, 2811, 2836, 2861, 2887, 2912, 2937, 2962, 2987, 3012, 3037, 3062, 3087, 3112, 3137, 3162, 3187, 3213, 3238, 3263, 3288, 3313, 3338, 3363, 3388, 3413, 3438, 3463, 3488, 3513, 3539, 3564, 3589, 3614, 3639, 3664, 3689, 3714, 3739, 3764, 3789, 3814, 3839, 3864, 3889, 3915, 3940, 3965, 3990, 4015, 4040, 4065, 4090, 4115, 4140, 4165, 4190, 4215, 4240, 4265, 4290, 4315, 4341, 4366, 4391, 4416, 4441, 4466, 4491, 4516, 4541, 4566, 4591, 4616, 4641, 4666, 4691, 4716, 4741, 4766, 4791, 4816, 4841, 4867, 4892, 4917, 4942, 4967, 4992, 5017, 5042, 5067, 5092, 5117, 5142, 5167, 5192, 5217, 5242, 5267, 5292, 5317, 5342, 5367, 5392, 5417, 5442, 5467, 5492, 5517, 5542, 5567, 5592, 5617, 5642, 5667, 5692, 5717, 5742, 5767, 5792, 5817, 5842, 5867, 5892, 5917, 5942, 5967, 5992, 6017, 6042, 6067, 6092, 6117, 6142, 6167, 6192, 6217, 6242, 6267, 6292, 6317, 6342, 6367, 6392, 6417, 6442, 6467, 6492, 6517, 6542, 6567, 6592, 6617, 6642, 6667, 6692, 6717, 6742, 6767, 6792, 6817, 6842, 6867, 6892, 6917, 6942, 6967, 6992, 7017, 7042, 7067, 7092, 7117, 7142, 7167, 7192, 7217, 7241, 7266, 7291, 7316, 7341, 7366, 7391, 7416, 7441, 7466, 7491, 7516, 7541, 7566, 7591, 7616, 7641, 7666, 7690, 7715, 7740, 7765, 7790, 7815, 7840, 7865, 7890, 7915, 7940, 7965, 7990, 8015, 8039, 8064, 8089, 8114, 8139, 8164, 8189, 8214, 8239, 8264, 8289, 8313, 8338, 8363, 8388, 8413, 8438, 8463, 8488, 8513, 8538, 8562, 8587, 8612, 8637, 8662, 8687, 8712, 8737, 8762, 8786, 8811, 8836, 8861, 8886, 8911, 8936, 8961, 8985, 9010, 9035, 9060, 9085, 9110, 9135, 9160, 9184, 9209, 9234, 9259, 9284, 9309, 9334, 9358, 9383, 9408, 9433, 9458, 9483, 9507, 9532, 9557, 9582, 9607, 9632, 9656, 9681, 9706, 9731, 9756, 9781, 9805, 9830, 9855, 9880, 9905, 9930, 9954, 9979, 10004, 10029, 10054, 10078, 10103, 10128, 10153, 10178, 10202, 10227, 10252, 10277, 10302, 10326, 10351, 10376, 10401, 10426, 10450, 10475, 10500, 10525, 10550, 10574, 10599, 10624, 10649, 10673, 10698, 10723, 10748, 10773, 10797, 10822, 10847, 10872, 10896, 10921, 10946, 10971, 10995, 11020, 11045, 11070, 11094, 11119, 11144, 11169, 11193, 11218, 11243, 11268, 11292, 11317, 11342, 11366, 11391, 11416, 11441, 11465, 11490, 11515, 11540, 11564, 11589, 11614, 11638, 11663, 11688, 11712, 11737, 11762, 11787, 11811, 11836, 11861, 11885, 11910, 11935, 11959, 11984, 12009, 12033, 12058, 12083, 12108, 12132, 12157, 12182, 12206, 12231, 12256, 12280, 12305, 12330, 12354, 12379, 12404, 12428, 12453, 12477, 12502, 12527, 12551, 12576, 12601, 12625, 12650, 12675, 12699, 12724, 12748, 12773, 12798, 12822, 12847, 12872, 12896, 12921, 12945, 12970, 12995, 13019, 13044, 13069, 13093, 13118, 13142, 13167, 13192, 13216, 13241, 13265, 13290, 13314, 13339, 13364, 13388, 13413, 13437, 13462, 13486, 13511, 13536, 13560, 13585, 13609, 13634, 13658, 13683, 13708, 13732, 13757, 13781, 13806, 13830, 13855, 13879, 13904, 13928, 13953, 13978, 14002, 14027, 14051, 14076, 14100, 14125, 14149, 14174, 14198, 14223, 14247, 14272, 14296, 14321, 14345, 14370, 14394, 14419, 14443, 14468, 14492, 14517, 14541, 14566, 14590, 14615, 14639, 14664, 14688, 14712, 14737, 14761, 14786, 14810, 14835, 14859, 14884, 14908, 14933, 14957, 14981, 15006, 15030, 15055, 15079, 15104, 15128, 15153, 15177, 15201, 15226, 15250, 15275, 15299, 15323, 15348, 15372, 15397, 15421, 15446, 15470, 15494, 15519, 15543, 15567, 15592, 15616, 15641, 15665, 15689, 15714, 15738, 15763, 15787, 15811, 15836, 15860, 15884, 15909, 15933, 15957, 15982, 16006, 16030, 16055, 16079, 16104, 16128, 16152, 16177, 16201, 16225, 16249, 16274, 16298, 16322, 16347, 16371, 16395, 16420, 16444, 16468, 16493, 16517, 16541, 16566, 16590, 16614, 16638, 16663, 16687, 16711, 16735, 16760, 16784, 16808, 16833, 16857, 16881, 16905, 16930, 16954, 16978, 17002, 17027, 17051, 17075, 17099, 17124, 17148, 17172, 17196, 17221, 17245, 17269, 17293, 17317, 17342, 17366, 17390, 17414, 17438, 17463, 17487, 17511, 17535, 17559, 17584, 17608, 17632, 17656, 17680, 17705, 17729, 17753, 17777, 17801, 17825, 17850, 17874, 17898, 17922, 17946, 17970, 17994, 18019, 18043, 18067, 18091, 18115, 18139, 18163, 18187, 18212, 18236, 18260, 18284, 18308, 18332, 18356, 18380, 18404, 18429, 18453, 18477, 18501, 18525, 18549, 18573, 18597, 18621, 18645, 18669, 18693, 18718, 18742, 18766, 18790, 18814, 18838, 18862, 18886, 18910, 18934, 18958, 18982, 19006, 19030, 19054, 19078, 19102, 19126, 19150, 19174, 19198, 19222, 19246, 19270, 19294, 19318, 19342, 19366, 19390, 19414, 19438, 19462, 19486, 19510, 19534, 19558, 19582, 19606, 19630, 19654, 19678, 19702, 19726, 19750, 19774, 19797, 19821, 19845, 19869, 19893, 19917, 19941, 19965, 19989, 20013, 20037, 20061, 20085, 20108, 20132, 20156, 20180, 20204, 20228, 20252, 20276, 20299, 20323, 20347, 20371, 20395, 20419, 20443, 20467, 20490, 20514, 20538, 20562, 20586, 20610, 20633, 20657, 20681, 20705, 20729, 20753, 20776, 20800, 20824, 20848, 20872, 20895, 20919, 20943, 20967, 20991, 21014, 21038, 21062, 21086, 21109, 21133, 21157, 21181, 21204, 21228, 21252, 21276, 21300, 21323, 21347, 21371, 21394, 21418, 21442, 21466, 21489, 21513, 21537, 21561, 21584, 21608, 21632, 21655, 21679, 21703, 21726, 21750, 21774, 21797, 21821, 21845, 21868, 21892, 21916, 21939, 21963, 21987, 22010, 22034, 22058, 22081, 22105, 22129, 22152, 22176, 22200, 22223, 22247, 22270, 22294, 22318, 22341, 22365, 22388, 22412, 22436, 22459, 22483, 22506, 22530, 22554, 22577, 22601, 22624, 22648, 22671, 22695, 22718, 22742, 22766, 22789, 22813, 22836, 22860, 22883, 22907, 22930, 22954, 22977, 23001, 23024, 23048, 23071, 23095, 23118, 23142, 23165, 23189, 23212, 23236, 23259, 23283, 23306, 23330, 23353, 23377, 23400, 23423, 23447, 23470, 23494, 23517, 23541, 23564, 23588, 23611, 23634, 23658, 23681, 23705, 23728, 23751, 23775, 23798, 23822, 23845, 23868, 23892, 23915, 23939, 23962, 23985, 24009, 24032, 24055, 24079, 24102, 24125, 24149, 24172, 24195, 24219, 24242, 24265, 24289, 24312, 24335, 24359, 24382, 24405, 24429, 24452, 24475, 24498, 24522, 24545, 24568, 24592, 24615, 24638, 24661, 24685, 24708, 24731, 24754, 24778, 24801, 24824, 24847, 24871, 24894, 24917, 24940, 24964, 24987, 25010, 25033, 25056, 25080, 25103, 25126, 25149, 25172, 25195, 25219, 25242, 25265, 25288, 25311, 25334, 25358, 25381, 25404, 25427, 25450, 25473, 25496, 25520, 25543, 25566, 25589, 25612, 25635, 25658, 25681, 25705, 25728, 25751, 25774, 25797, 25820, 25843, 25866, 25889, 25912, 25935, 25958, 25981, 26004, 26027, 26051, 26074, 26097, 26120, 26143, 26166, 26189, 26212, 26235, 26258, 26281, 26304, 26327, 26350, 26373, 26396, 26419, 26442, 26465, 26488, 26511, 26534, 26556, 26579, 26602, 26625, 26648, 26671, 26694, 26717, 26740, 26763, 26786, 26809, 26832, 26855, 26877, 26900, 26923, 26946, 26969, 26992, 27015, 27038, 27061, 27083, 27106, 27129, 27152, 27175, 27198, 27220, 27243, 27266, 27289, 27312, 27335, 27357, 27380, 27403, 27426, 27449, 27471, 27494, 27517, 27540, 27563, 27585, 27608, 27631, 27654, 27676, 27699, 27722, 27745, 27767, 27790, 27813, 27836, 27858, 27881, 27904, 27927, 27949, 27972, 27995, 28017, 28040, 28063, 28085, 28108, 28131, 28154, 28176, 28199, 28222, 28244, 28267, 28289, 28312, 28335, 28357, 28380, 28403, 28425, 28448, 28471, 28493, 28516, 28538, 28561, 28584, 28606, 28629, 28651, 28674, 28696, 28719, 28742, 28764, 28787, 28809, 28832, 28854, 28877, 28899, 28922, 28945, 28967, 28990, 29012, 29035, 29057, 29080, 29102, 29125, 29147, 29170, 29192, 29215, 29237, 29259, 29282, 29304, 29327, 29349, 29372, 29394, 29417, 29439, 29462, 29484, 29506, 29529, 29551, 29574, 29596, 29618, 29641, 29663, 29686, 29708, 29730, 29753, 29775, 29797, 29820, 29842, 29865, 29887, 29909, 29932, 29954, 29976, 29999, 30021, 30043, 30065, 30088, 30110, 30132, 30155, 30177, 30199, 30222, 30244, 30266, 30288, 30311, 30333, 30355, 30377, 30400, 30422, 30444, 30466, 30489, 30511, 30533, 30555, 30577, 30600, 30622, 30644, 30666, 30688, 30711, 30733, 30755, 30777, 30799, 30821, 30844, 30866, 30888, 30910, 30932, 30954, 30976, 30999, 31021, 31043, 31065, 31087, 31109, 31131, 31153, 31175, 31197, 31220, 31242, 31264, 31286, 31308, 31330, 31352, 31374, 31396, 31418, 31440, 31462, 31484, 31506, 31528, 31550, 31572, 31594, 31616, 31638, 31660, 31682, 31704, 31726, 31748, 31770, 31792, 31814, 31836, 31858, 31880, 31902, 31924, 31946, 31967, 31989, 32011, 32033, 32055, 32077, 32099, 32121, 32143, 32165, 32186, 32208, 32230, 32252, 32274, 32296, 32318, 32339, 32361, 32383, 32405, 32427, 32449, 32470, 32492, 32514, 32536, 32558, 32579, 32601, 32623, 32645, 32666, 32688, 32710, 32732, 32754, 32775, 32797, 32819, 32840, 32862, 32884, 32906, 32927, 32949, 32971, 32992, 33014, 33036, 33057, 33079, 33101, 33123, 33144, 33166, 33187, 33209, 33231, 33252, 33274, 33296, 33317, 33339, 33361, 33382, 33404, 33425, 33447, 33469, 33490, 33512, 33533, 33555, 33576, 33598, 33620, 33641, 33663, 33684, 33706, 33727, 33749, 33770, 33792, 33813, 33835, 33856, 33878, 33899, 33921, 33942, 33964, 33985, 34007, 34028, 34050, 34071, 34092, 34114, 34135, 34157, 34178, 34200, 34221, 34242, 34264, 34285, 34307, 34328, 34349, 34371, 34392, 34414, 34435, 34456, 34478, 34499, 34520, 34542, 34563, 34584, 34606, 34627, 34648, 34670, 34691, 34712, 34734, 34755, 34776, 34797, 34819, 34840, 34861, 34882, 34904, 34925, 34946, 34967, 34989, 35010, 35031, 35052, 35074, 35095, 35116, 35137, 35158, 35180, 35201, 35222, 35243, 35264, 35285, 35307, 35328, 35349, 35370, 35391, 35412, 35433, 35454, 35476, 35497, 35518, 35539, 35560, 35581, 35602, 35623, 35644, 35665, 35686, 35708, 35729, 35750, 35771, 35792, 35813, 35834, 35855, 35876, 35897, 35918, 35939, 35960, 35981, 36002, 36023, 36044, 36065, 36086, 36107, 36128, 36148, 36169, 36190, 36211, 36232, 36253, 36274, 36295, 36316, 36337, 36358, 36379, 36399, 36420, 36441, 36462, 36483, 36504, 36525, 36545, 36566, 36587, 36608, 36629, 36650, 36670, 36691, 36712, 36733, 36754, 36774, 36795, 36816, 36837, 36857, 36878, 36899, 36920, 36940, 36961, 36982, 37003, 37023, 37044, 37065, 37086, 37106, 37127, 37148, 37168, 37189, 37210, 37230, 37251, 37272, 37292, 37313, 37334, 37354, 37375, 37395, 37416, 37437, 37457, 37478, 37498, 37519, 37540, 37560, 37581, 37601, 37622, 37642, 37663, 37684, 37704, 37725, 37745, 37766, 37786, 37807, 37827, 37848, 37868, 37889, 37909, 37930, 37950, 37971, 37991, 38012, 38032, 38052, 38073, 38093, 38114, 38134, 38155, 38175, 38195, 38216, 38236, 38257, 38277, 38297, 38318, 38338, 38358, 38379, 38399, 38419, 38440, 38460, 38480, 38501, 38521, 38541, 38562, 38582, 38602, 38623, 38643, 38663, 38683, 38704, 38724, 38744, 38764, 38785, 38805, 38825, 38845, 38866, 38886, 38906, 38926, 38946, 38967, 38987, 39007, 39027, 39047, 39067, 39088, 39108, 39128, 39148, 39168, 39188, 39208, 39229, 39249, 39269, 39289, 39309, 39329, 39349, 39369, 39389, 39409, 39429, 39449, 39470, 39490, 39510, 39530, 39550, 39570, 39590, 39610, 39630, 39650, 39670, 39690, 39710, 39730, 39750, 39770, 39789, 39809, 39829, 39849, 39869, 39889, 39909, 39929, 39949, 39969, 39989, 40009, 40028, 40048, 40068, 40088, 40108, 40128, 40148, 40167, 40187, 40207, 40227, 40247, 40267, 40286, 40306, 40326, 40346, 40366, 40385, 40405, 40425, 40445, 40464, 40484, 40504, 40524, 40543, 40563, 40583, 40603, 40622, 40642, 40662, 40681, 40701, 40721, 40740, 40760, 40780, 40799, 40819, 40839, 40858, 40878, 40897, 40917, 40937, 40956, 40976, 40995, 41015, 41035, 41054, 41074, 41093, 41113, 41132, 41152, 41172, 41191, 41211, 41230, 41250, 41269, 41289, 41308, 41328, 41347, 41367, 41386, 41406, 41425, 41444, 41464, 41483, 41503, 41522, 41542, 41561, 41580, 41600, 41619, 41639, 41658, 41677, 41697, 41716, 41736, 41755, 41774, 41794, 41813, 41832, 41852, 41871, 41890, 41909, 41929, 41948, 41967, 41987, 42006, 42025, 42044, 42064, 42083, 42102, 42121, 42141, 42160, 42179, 42198, 42218, 42237, 42256, 42275, 42294, 42313, 42333, 42352, 42371, 42390, 42409, 42428, 42448, 42467, 42486, 42505, 42524, 42543, 42562, 42581, 42600, 42619, 42639, 42658, 42677, 42696, 42715, 42734, 42753, 42772, 42791, 42810, 42829, 42848, 42867, 42886, 42905, 42924, 42943, 42962, 42981, 43000, 43019, 43038, 43057, 43075, 43094, 43113, 43132, 43151, 43170, 43189, 43208, 43227, 43245, 43264, 43283, 43302, 43321, 43340, 43359, 43377, 43396, 43415, 43434, 43453, 43471, 43490, 43509, 43528, 43547, 43565, 43584, 43603, 43622, 43640, 43659, 43678, 43696, 43715, 43734, 43753, 43771, 43790, 43809, 43827, 43846, 43865, 43883, 43902, 43921, 43939, 43958, 43976, 43995, 44014, 44032, 44051, 44069, 44088, 44107, 44125, 44144, 44162, 44181, 44199, 44218, 44236, 44255, 44273, 44292, 44310, 44329, 44347, 44366, 44384, 44403, 44421, 44440, 44458, 44477, 44495, 44514, 44532, 44550, 44569, 44587, 44606, 44624, 44642, 44661, 44679, 44697, 44716, 44734, 44753, 44771, 44789, 44808, 44826, 44844, 44862, 44881, 44899, 44917, 44936, 44954, 44972, 44990, 45009, 45027, 45045, 45063, 45082, 45100, 45118, 45136, 45154, 45173, 45191, 45209, 45227, 45245, 45264, 45282, 45300, 45318, 45336, 45354, 45372, 45390, 45409, 45427, 45445, 45463, 45481, 45499, 45517, 45535, 45553, 45571, 45589, 45607, 45625, 45643, 45661, 45679, 45697, 45715, 45733, 45751, 45769, 45787, 45805, 45823, 45841, 45859, 45877, 45895, 45913, 45931, 45949, 45967, 45985, 46002, 46020, 46038, 46056, 46074, 46092, 46110, 46127, 46145, 46163, 46181, 46199, 46217, 46234, 46252, 46270, 46288, 46305, 46323, 46341, 46359, 46376, 46394, 46412, 46430, 46447, 46465, 46483, 46500, 46518, 46536, 46554, 46571, 46589, 46606, 46624, 46642, 46659, 46677, 46695, 46712, 46730, 46747, 46765, 46783, 46800, 46818, 46835, 46853, 46871, 46888, 46906, 46923, 46941, 46958, 46976, 46993, 47011, 47028, 47046, 47063, 47081, 47098, 47116, 47133, 47150, 47168, 47185, 47203, 47220, 47238, 47255, 47272, 47290, 47307, 47324, 47342, 47359, 47377, 47394, 47411, 47429, 47446, 47463, 47480, 47498, 47515, 47532, 47550, 47567, 47584, 47601, 47619, 47636, 47653, 47670, 47688, 47705, 47722, 47739, 47756, 47774, 47791, 47808, 47825, 47842, 47860, 47877, 47894, 47911, 47928, 47945, 47962, 47979, 47997, 48014, 48031, 48048, 48065, 48082, 48099, 48116, 48133, 48150, 48167, 48184, 48201, 48218, 48235, 48252, 48269, 48286, 48303, 48320, 48337, 48354, 48371, 48388, 48405, 48422, 48439, 48456, 48472, 48489, 48506, 48523, 48540, 48557, 48574, 48591, 48607, 48624, 48641, 48658, 48675, 48692, 48708, 48725, 48742, 48759, 48775, 48792, 48809, 48826, 48842, 48859, 48876, 48893, 48909, 48926, 48943, 48960, 48976, 48993, 49010, 49026, 49043, 49060, 49076, 49093, 49109, 49126, 49143, 49159, 49176, 49192, 49209, 49226, 49242, 49259, 49275, 49292, 49308, 49325, 49341, 49358, 49375, 49391, 49408, 49424, 49441, 49457, 49473, 49490, 49506, 49523, 49539, 49556, 49572, 49589, 49605, 49621, 49638, 49654, 49671, 49687, 49703, 49720, 49736, 49752, 49769, 49785, 49801, 49818, 49834, 49850, 49867, 49883, 49899, 49915, 49932, 49948, 49964, 49980, 49997, 50013, 50029, 50045, 50062, 50078, 50094, 50110, 50126, 50142, 50159, 50175, 50191, 50207, 50223, 50239, 50255, 50272, 50288, 50304, 50320, 50336, 50352, 50368, 50384, 50400, 50416, 50432, 50448, 50464, 50480, 50496, 50512, 50528, 50544, 50560, 50576, 50592, 50608, 50624, 50640, 50656, 50672, 50688, 50704, 50720, 50736, 50751, 50767, 50783, 50799, 50815, 50831, 50847, 50862, 50878, 50894, 50910, 50926, 50942, 50957, 50973, 50989, 51005, 51020, 51036, 51052, 51068, 51083, 51099, 51115, 51131, 51146, 51162, 51178, 51193, 51209, 51225, 51240, 51256, 51272, 51287, 51303, 51319, 51334, 51350, 51365, 51381, 51397, 51412, 51428, 51443, 51459, 51474, 51490, 51505, 51521, 51536, 51552, 51567, 51583, 51598, 51614, 51629, 51645, 51660, 51676, 51691, 51707, 51722, 51737, 51753, 51768, 51784, 51799, 51814, 51830, 51845, 51860, 51876, 51891, 51906, 51922, 51937, 51952, 51968, 51983, 51998, 52014, 52029, 52044, 52059, 52075, 52090, 52105, 52120, 52136, 52151, 52166, 52181, 52196, 52212, 52227, 52242, 52257, 52272, 52287, 52302, 52318, 52333, 52348, 52363, 52378, 52393, 52408, 52423, 52438, 52453, 52468, 52483, 52498, 52513, 52528, 52544, 52559, 52573, 52588, 52603, 52618, 52633, 52648, 52663, 52678, 52693, 52708, 52723, 52738, 52753, 52768, 52783, 52797, 52812, 52827, 52842, 52857, 52872, 52887, 52901, 52916, 52931, 52946, 52961, 52975, 52990, 53005, 53020, 53034, 53049, 53064, 53079, 53093, 53108, 53123, 53138, 53152, 53167, 53182, 53196, 53211, 53226, 53240, 53255, 53270, 53284, 53299, 53313, 53328, 53343, 53357, 53372, 53386, 53401, 53415, 53430, 53444, 53459, 53473, 53488, 53503, 53517, 53531, 53546, 53560, 53575, 53589, 53604, 53618, 53633, 53647, 53662, 53676, 53690, 53705, 53719, 53734, 53748, 53762, 53777, 53791, 53805, 53820, 53834, 53848, 53863, 53877, 53891, 53905, 53920, 53934, 53948, 53962, 53977, 53991, 54005, 54019, 54034, 54048, 54062, 54076, 54090, 54105, 54119, 54133, 54147, 54161, 54175, 54189, 54204, 54218, 54232, 54246, 54260, 54274, 54288, 54302, 54316, 54330, 54344, 54358, 54372, 54386, 54400, 54414, 54428, 54442, 54456, 54470, 54484, 54498, 54512, 54526, 54540, 54554, 54568, 54582, 54596, 54609, 54623, 54637, 54651, 54665, 54679, 54693, 54706, 54720, 54734, 54748, 54762, 54775, 54789, 54803, 54817, 54831, 54844, 54858, 54872, 54885, 54899, 54913, 54927, 54940, 54954, 54968, 54981, 54995, 55009, 55022, 55036, 55050, 55063, 55077, 55090, 55104, 55118, 55131, 55145, 55158, 55172, 55185, 55199, 55212, 55226, 55240, 55253, 55267, 55280, 55293, 55307, 55320, 55334, 55347, 55361, 55374, 55388, 55401, 55414, 55428, 55441, 55455, 55468, 55481, 55495, 55508, 55521, 55535, 55548, 55561, 55575, 55588, 55601, 55615, 55628, 55641, 55654, 55668, 55681, 55694, 55707, 55721, 55734, 55747, 55760, 55773, 55787, 55800, 55813, 55826, 55839, 55852, 55866, 55879, 55892, 55905, 55918, 55931, 55944, 55957, 55970, 55983, 55996, 56009, 56022, 56035, 56048, 56061, 56074, 56087, 56100, 56113, 56126, 56139, 56152, 56165, 56178, 56191, 56204, 56217, 56230, 56243, 56256, 56268, 56281, 56294, 56307, 56320, 56333, 56346, 56358, 56371, 56384, 56397, 56410, 56422, 56435, 56448, 56461, 56473, 56486, 56499, 56512, 56524, 56537, 56550, 56562, 56575, 56588, 56600, 56613, 56626, 56638, 56651, 56664, 56676, 56689, 56701, 56714, 56727, 56739, 56752, 56764, 56777, 56789, 56802, 56814, 56827, 56839, 56852, 56864, 56877, 56889, 56902, 56914, 56927, 56939, 56951, 56964, 56976, 56989, 57001, 57014, 57026, 57038, 57051, 57063, 57075, 57088, 57100, 57112, 57125, 57137, 57149, 57161, 57174, 57186, 57198, 57211, 57223, 57235, 57247, 57259, 57272, 57284, 57296, 57308, 57320, 57333, 57345, 57357, 57369, 57381, 57393, 57405, 57418, 57430, 57442, 57454, 57466, 57478, 57490, 57502, 57514, 57526, 57538, 57550, 57562, 57574, 57586, 57598, 57610, 57622, 57634, 57646, 57658, 57670, 57682, 57694, 57706, 57718, 57729, 57741, 57753, 57765, 57777, 57789, 57801, 57812, 57824, 57836, 57848, 57860, 57871, 57883, 57895, 57907, 57918, 57930, 57942, 57954, 57965, 57977, 57989, 58000, 58012, 58024, 58036, 58047, 58059, 58070, 58082, 58094, 58105, 58117, 58129, 58140, 58152, 58163, 58175, 58186, 58198, 58210, 58221, 58233, 58244, 58256, 58267, 58279, 58290, 58302, 58313, 58324, 58336, 58347, 58359, 58370, 58382, 58393, 58404, 58416, 58427, 58439, 58450, 58461, 58473, 58484, 58495, 58507, 58518, 58529, 58540, 58552, 58563, 58574, 58586, 58597, 58608, 58619, 58630, 58642, 58653, 58664, 58675, 58686, 58698, 58709, 58720, 58731, 58742, 58753, 58764, 58776, 58787, 58798, 58809, 58820, 58831, 58842, 58853, 58864, 58875, 58886, 58897, 58908, 58919, 58930, 58941, 58952, 58963, 58974, 58985, 58996, 59007, 59018, 59029, 59040, 59051, 59061, 59072, 59083, 59094, 59105, 59116, 59127, 59137, 59148, 59159, 59170, 59181, 59191, 59202, 59213, 59224, 59234, 59245, 59256, 59267, 59277, 59288, 59299, 59309, 59320, 59331, 59341, 59352, 59363, 59373, 59384, 59395, 59405, 59416, 59426, 59437, 59448, 59458, 59469, 59479, 59490, 59500, 59511, 59521, 59532, 59542, 59553, 59563, 59574, 59584, 59595, 59605, 59616, 59626, 59636, 59647, 59657, 59668, 59678, 59688, 59699, 59709, 59719, 59730, 59740, 59750, 59761, 59771, 59781, 59792, 59802, 59812, 59822, 59833, 59843, 59853, 59863, 59874, 59884, 59894, 59904, 59914, 59924, 59935, 59945, 59955, 59965, 59975, 59985, 59995, 60005, 60016, 60026, 60036, 60046, 60056, 60066, 60076, 60086, 60096, 60106, 60116, 60126, 60136, 60146, 60156, 60166, 60176, 60186, 60196, 60206, 60216, 60225, 60235, 60245, 60255, 60265, 60275, 60285, 60295, 60304, 60314, 60324, 60334, 60344, 60353, 60363, 60373, 60383, 60392, 60402, 60412, 60422, 60431, 60441, 60451, 60461, 60470, 60480, 60490, 60499, 60509, 60519, 60528, 60538, 60547, 60557, 60567, 60576, 60586, 60595, 60605, 60614, 60624, 60633, 60643, 60653, 60662, 60672, 60681, 60690, 60700, 60709, 60719, 60728, 60738, 60747, 60757, 60766, 60775, 60785, 60794, 60804, 60813, 60822, 60832, 60841, 60850, 60860, 60869, 60878, 60888, 60897, 60906, 60915, 60925, 60934, 60943, 60952, 60962, 60971, 60980, 60989, 60998, 61007, 61017, 61026, 61035, 61044, 61053, 61062, 61071, 61081, 61090, 61099, 61108, 61117, 61126, 61135, 61144, 61153, 61162, 61171, 61180, 61189, 61198, 61207, 61216, 61225, 61234, 61243, 61252, 61261, 61270, 61279, 61287, 61296, 61305, 61314, 61323, 61332, 61341, 61350, 61358, 61367, 61376, 61385, 61394, 61402, 61411, 61420, 61429, 61437, 61446, 61455, 61464, 61472, 61481, 61490, 61498, 61507, 61516, 61524, 61533, 61542, 61550, 61559, 61567, 61576, 61585, 61593, 61602, 61610, 61619, 61627, 61636, 61645, 61653, 61662, 61670, 61679, 61687, 61696, 61704, 61712, 61721, 61729, 61738, 61746, 61755, 61763, 61771, 61780, 61788, 61796, 61805, 61813, 61822, 61830, 61838, 61846, 61855, 61863, 61871, 61880, 61888, 61896, 61904, 61913, 61921, 61929, 61937, 61945, 61954, 61962, 61970, 61978, 61986, 61995, 62003, 62011, 62019, 62027, 62035, 62043, 62051, 62059, 62067, 62075, 62084, 62092, 62100, 62108, 62116, 62124, 62132, 62140, 62148, 62156, 62163, 62171, 62179, 62187, 62195, 62203, 62211, 62219, 62227, 62235, 62243, 62250, 62258, 62266, 62274, 62282, 62290, 62297, 62305, 62313, 62321, 62328, 62336, 62344, 62352, 62359, 62367, 62375, 62383, 62390, 62398, 62406, 62413, 62421, 62429, 62436, 62444, 62451, 62459, 62467, 62474, 62482, 62489, 62497, 62504, 62512, 62520, 62527, 62535, 62542, 62550, 62557, 62565, 62572, 62579, 62587, 62594, 62602, 62609, 62617, 62624, 62631, 62639, 62646, 62654, 62661, 62668, 62676, 62683, 62690, 62698, 62705, 62712, 62720, 62727, 62734, 62741, 62749, 62756, 62763, 62770, 62777, 62785, 62792, 62799, 62806, 62813, 62821, 62828, 62835, 62842, 62849, 62856, 62863, 62870, 62877, 62885, 62892, 62899, 62906, 62913, 62920, 62927, 62934, 62941, 62948, 62955, 62962, 62969, 62976, 62983, 62990, 62996, 63003, 63010, 63017, 63024, 63031, 63038, 63045, 63052, 63058, 63065, 63072, 63079, 63086, 63092, 63099, 63106, 63113, 63120, 63126, 63133, 63140, 63147, 63153, 63160, 63167, 63173, 63180, 63187, 63193, 63200, 63207, 63213, 63220, 63226, 63233, 63240, 63246, 63253, 63259, 63266, 63272, 63279, 63286, 63292, 63299, 63305, 63312, 63318, 63325, 63331, 63337, 63344, 63350, 63357, 63363, 63370, 63376, 63382, 63389, 63395, 63401, 63408, 63414, 63420, 63427, 63433, 63439, 63446, 63452, 63458, 63465, 63471, 63477, 63483, 63490, 63496, 63502, 63508, 63514, 63521, 63527, 63533, 63539, 63545, 63551, 63557, 63564, 63570, 63576, 63582, 63588, 63594, 63600, 63606, 63612, 63618, 63624, 63630, 63636, 63642, 63648, 63654, 63660, 63666, 63672, 63678, 63684, 63690, 63696, 63702, 63708, 63713, 63719, 63725, 63731, 63737, 63743, 63749, 63754, 63760, 63766, 63772, 63778, 63783, 63789, 63795, 63801, 63806, 63812, 63818, 63824, 63829, 63835, 63841, 63846, 63852, 63858, 63863, 63869, 63874, 63880, 63886, 63891, 63897, 63902, 63908, 63914, 63919, 63925, 63930, 63936, 63941, 63947, 63952, 63958, 63963, 63969, 63974, 63980, 63985, 63990, 63996, 64001, 64007, 64012, 64017, 64023, 64028, 64033, 64039, 64044, 64049, 64055, 64060, 64065, 64071, 64076, 64081, 64086, 64092, 64097, 64102, 64107, 64113, 64118, 64123, 64128, 64133, 64138, 64144, 64149, 64154, 64159, 64164, 64169, 64174, 64179, 64185, 64190, 64195, 64200, 64205, 64210, 64215, 64220, 64225, 64230, 64235, 64240, 64245, 64250, 64255, 64260, 64264, 64269, 64274, 64279, 64284, 64289, 64294, 64299, 64304, 64308, 64313, 64318, 64323, 64328, 64332, 64337, 64342, 64347, 64352, 64356, 64361, 64366, 64370, 64375, 64380, 64385, 64389, 64394, 64399, 64403, 64408, 64413, 64417, 64422, 64426, 64431, 64436, 64440, 64445, 64449, 64454, 64458, 64463, 64467, 64472, 64476, 64481, 64485, 64490, 64494, 64499, 64503, 64508, 64512, 64516, 64521, 64525, 64530, 64534, 64538, 64543, 64547, 64551, 64556, 64560, 64564, 64569, 64573, 64577, 64582, 64586, 64590, 64594, 64599, 64603, 64607, 64611, 64615, 64620, 64624, 64628, 64632, 64636, 64640, 64645, 64649, 64653, 64657, 64661, 64665, 64669, 64673, 64677, 64681, 64685, 64689, 64693, 64697, 64701, 64705, 64709, 64713, 64717, 64721, 64725, 64729, 64733, 64737, 64741, 64745, 64749, 64753, 64756, 64760, 64764, 64768, 64772, 64776, 64779, 64783, 64787, 64791, 64795, 64798, 64802, 64806, 64810, 64813, 64817, 64821, 64824, 64828, 64832, 64835, 64839, 64843, 64846, 64850, 64854, 64857, 64861, 64864, 64868, 64872, 64875, 64879, 64882, 64886, 64889, 64893, 64896, 64900, 64903, 64907, 64910, 64914, 64917, 64921, 64924, 64927, 64931, 64934, 64938, 64941, 64944, 64948, 64951, 64954, 64958, 64961, 64964, 64968, 64971, 64974, 64978, 64981, 64984, 64987, 64991, 64994, 64997, 65000, 65003, 65007, 65010, 65013, 65016, 65019, 65022, 65026, 65029, 65032, 65035, 65038, 65041, 65044, 65047, 65050, 65053, 65056, 65059, 65062, 65065, 65068, 65071, 65074, 65077, 65080, 65083, 65086, 65089, 65092, 65095, 65098, 65101, 65104, 65106, 65109, 65112, 65115, 65118, 65121, 65124, 65126, 65129, 65132, 65135, 65137, 65140, 65143, 65146, 65148, 65151, 65154, 65157, 65159, 65162, 65165, 65167, 65170, 65173, 65175, 65178, 65180, 65183, 65186, 65188, 65191, 65193, 65196, 65199, 65201, 65204, 65206, 65209, 65211, 65214, 65216, 65219, 65221, 65223, 65226, 65228, 65231, 65233, 65236, 65238, 65240, 65243, 65245, 65248, 65250, 65252, 65255, 65257, 65259, 65261, 65264, 65266, 65268, 65271, 65273, 65275, 65277, 65280, 65282, 65284, 65286, 65288, 65290, 65293, 65295, 65297, 65299, 65301, 65303, 65305, 65308, 65310, 65312, 65314, 65316, 65318, 65320, 65322, 65324, 65326, 65328, 65330, 65332, 65334, 65336, 65338, 65340, 65342, 65344, 65346, 65348, 65349, 65351, 65353, 65355, 65357, 65359, 65361, 65362, 65364, 65366, 65368, 65370, 65371, 65373, 65375, 65377, 65378, 65380, 65382, 65384, 65385, 65387, 65389, 65390, 65392, 65394, 65395, 65397, 65399, 65400, 65402, 65404, 65405, 65407, 65408, 65410, 65411, 65413, 65414, 65416, 65417, 65419, 65420, 65422, 65423, 65425, 65426, 65428, 65429, 65431, 65432, 65434, 65435, 65436, 65438, 65439, 65440, 65442, 65443, 65444, 65446, 65447, 65448, 65450, 65451, 65452, 65453, 65455, 65456, 65457, 65458, 65460, 65461, 65462, 65463, 65464, 65466, 65467, 65468, 65469, 65470, 65471, 65472, 65474, 65475, 65476, 65477, 65478, 65479, 65480, 65481, 65482, 65483, 65484, 65485, 65486, 65487, 65488, 65489, 65490, 65491, 65492, 65493, 65494, 65494, 65495, 65496, 65497, 65498, 65499, 65500, 65500, 65501, 65502, 65503, 65504, 65504, 65505, 65506, 65507, 65507, 65508, 65509, 65510, 65510, 65511, 65512, 65512, 65513, 65514, 65514, 65515, 65516, 65516, 65517, 65518, 65518, 65519, 65519, 65520, 65520, 65521, 65521, 65522, 65522, 65523, 65523, 65524, 65524, 65525, 65525, 65526, 65526, 65527, 65527, 65528, 65528, 65528, 65529, 65529, 65529, 65530, 65530, 65530, 65531, 65531, 65531, 65532, 65532, 65532, 65532, 65533, 65533, 65533, 65533, 65534, 65534, 65534, 65534, 65534, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536};

/*
  -----------------------------------------------------------------------------
  DESCRIPTION: setup_pins() initializes the motor control pins as outputs and uses the fast PWM to set initial voltage references. The motor is then placed in "park" mode

  OPERATION:   We first initialize the pins as outputs, set the motor in "park" and limit the current it can consume.

  ARGUMENTS: None

  RETURNS: None

  LOCAL VARIABLES: None

  SHARED VARIABLES: None

  GLOBAL VARIABLES: None

  DEPENDENCIES:
        MotorControl.h: Contains macros and fuction delcarations.
        fastPWM.h:      Contains analogFastWrite, a higher-frequency PWM implementation
  -----------------------------------------------------------------------------
*/ 

void setup_pins(){
  pinMode(VREF_2, OUTPUT);
  pinMode(VREF_1, OUTPUT);
  pinMode(IN_4, OUTPUT);
  pinMode(IN_3, OUTPUT);
  pinMode(IN_2, OUTPUT);
  pinMode(IN_1, OUTPUT);

  pinMode(ledPin, OUTPUT);

  analogFastWrite(VREF_2, 0.33 * uMAX);
  analogFastWrite(VREF_1, 0.33 * uMAX);


  // From the motor driver datasheet, this parks the motor
  IN_4_HIGH();
  IN_3_HIGH();
  IN_2_HIGH();
  IN_1_HIGH();

  return;
}

/*
  -----------------------------------------------------------------------------
  DESCRIPTION: stop_motor() initializes the motor control pins as outputs and uses the fast PWM to set initial voltage references. The motor is then placed in "park" mode

  OPERATION:   Stop interrupts, then pause the motor.

  ARGUMENTS: None

  RETURNS: None

  LOCAL VARIABLES: None

  SHARED VARIABLES: None

  GLOBAL VARIABLES: None

  DEPENDENCIES:
        MotorControl.h: Contains macros and fuction delcarations.
        fastPWM.h:      Contains analogFastWrite, a higher-frequency PWM implementation
        TimeControlInt.h: For stopping interrupts
  -----------------------------------------------------------------------------
*/ 
void stop_motor(){
  disable_TCInterrupts();

  IN_4_HIGH(); 
  IN_3_HIGH();
  IN_2_HIGH();
  IN_1_HIGH();

  return;
}

/*
  -----------------------------------------------------------------------------
  DESCRIPTION: int sine_lookup(int angle) takes a value between 0 and VALS_PER_REV-1 and returns the sine of that value multiplied by 2^16.

  OPERATION:   First, we determine which quadrant of the sine wave we are in, then we look up a value from the sine table and transform it as needed to get the correct results.

  ARGUMENTS: angle, an integer between 0 and VALS_PER_REV-1

  RETURNS: sine, an integer between 0 and 2^16

  LOCAL VARIABLES: section, and integer from 0 to 3 that tells us which quadrant we are in
                   angle, the angle input mod QUARTER_TURN

  SHARED VARIABLES: None

  GLOBAL VARIABLES: None

  DEPENDENCIES:
        MotorControl.h: Contains macros and fuction delcarations.
        fastPWM.h:      Contains analogFastWrite, a higher-frequency PWM implementation
        TimeControlInt.h: For stopping interrupts
  -----------------------------------------------------------------------------
*/ 
int sine_lookup(int angle){
  // angle must be between 0 and VALS_PER_REV-1
  // first: divide angle until it is either 0, 1, 2, or 3
  int section = floor(angle/QUARTER_TURN);
  angle = angle % QUARTER_TURN;
  switch(section){
    case 0:
      return(SINETABLE[angle]);
      break;
    case 1:
      return(SINETABLE[QUARTER_TURN - angle]);
      break;
    case 2:
      return(-SINETABLE[angle]);
      break;
    default:
      return(-SINETABLE[QUARTER_TURN - angle]);
  }
}

/*
  -----------------------------------------------------------------------------
  DESCRIPTION: Given a target angle and an amount of effort, rotate to that angle without exceeding the current limit

  OPERATION:   First, we multiply the target angle by a scaling constant, then adjusted to fall in the range from 0 to VALS_PER_REV-1. We find the sine and cosine of this value. We then use the sines and cosines to determine how much current should go to each coil and set the coils to rotate in the correct direction.

  ARGUMENTS: theta, an integer representing the target angle.
             effort, an integer from 0 to 255 representing the current limit.

  RETURNS: none

  INPUTS: none

  OUTPUTS: The motor moves to the target angle.

  LOCAL VARIABLES: int angle_1, angle_2 represent the target angle
                   int sin_coil_A, sin_coil_B represent the sines and cosines of the target angle
                   int v_coil_A, v_coil_B represent the power going to each coil

  SHARED VARIABLES: None

  GLOBAL VARIABLES: None

  DEPENDENCIES:
        MotorControl.h: Contains macros and fuction delcarations.
        fastPWM.h:      Contains analogFastWrite, a higher-frequency PWM implementation
  -----------------------------------------------------------------------------
*/ 

void output(int theta, int effort) {
  int angle_1;
  int angle_2;
  int v_coil_A;
  int v_coil_B;
  int sin_coil_A;
  int sin_coil_B;
  const int phase_multiplier = STEP_PER_REV / 4;

  angle_1 = ((phase_multiplier * theta) % VALS_PER_REV);
  angle_2 = ((phase_multiplier * theta) + QUARTER_TURN % VALS_PER_REV);
  
  // Call a function to get the sine using lookup tables
  sin_coil_A  = sine_lookup(angle_1);
  sin_coil_B = sine_lookup(angle_2);

  // Multiply by effort and then divide by 2^16 (max value in sine lookup) to get correct PWM
  v_coil_A = ((effort * sin_coil_A)>>16);
  v_coil_B = ((effort * sin_coil_B)>>16);

  analogFastWrite(VREF_1, abs(v_coil_A));
  analogFastWrite(VREF_2, abs(v_coil_B));

  if (v_coil_A >= 0)  {
    IN_2_HIGH();  //REG_PORT_OUTSET0 = PORT_PA21;     //write IN_2 HIGH
    IN_1_LOW();   //REG_PORT_OUTCLR0 = PORT_PA06;     //write IN_1 LOW
  }
  else  {
    IN_2_LOW();   //REG_PORT_OUTCLR0 = PORT_PA21;     //write IN_2 LOW
    IN_1_HIGH();  //REG_PORT_OUTSET0 = PORT_PA06;     //write IN_1 HIGH
  }

  if (v_coil_B >= 0)  {
    IN_4_HIGH();  //REG_PORT_OUTSET0 = PORT_PA20;     //write IN_4 HIGH
    IN_3_LOW();   //REG_PORT_OUTCLR0 = PORT_PA15;     //write IN_3 LOW
  }
  else  {
    IN_4_LOW();     //REG_PORT_OUTCLR0 = PORT_PA20;     //write IN_4 LOW
    IN_3_HIGH();    //REG_PORT_OUTSET0 = PORT_PA15;     //write IN_3 HIGH
  }

}


/*
  -----------------------------------------------------------------------------
  DESCRIPTION: one_step() instructs the motor to rotate one step clockwise or counterclockwise from its current position

  OPERATION:   We are keeping track of the absolute position of the motor through the shared variable &step.
               First, check the direction we want to go, then step in that direction. We then set our output to the new absolute postion using 1/4 of the maximum effort. We then wait for the motor to settle.

  ARGUMENTS: 
        bool dir - either CW or CCW, as defined in the macros
        int  step - variable indicating the absolute position of the motor

  RETURNS: step, the new step value

  LOCAL VARIABLES: None

  SHARED VARIABLES: None

  GLOBAL VARIABLES: None

  INPUTS: None

  OUTPUTS: the motor moves a step in the direction specified

  DEPENDENCIES:
        MotorControl.h: Contains macros and fuction delcarations.
  -----------------------------------------------------------------------------
*/ 

int one_step(bool dir, int step) {
  // Log the step in the shared variable
  if (dir==CCW) {
    step += 1;
  }
  else {
    step -= 1;
  }

  output(VAL_PER_STEP * step, uMAX>>2);
  delay(MOTOR_SETTLE);

  return step;
}